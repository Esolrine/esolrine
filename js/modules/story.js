export class StoryManager {
    constructor() {
        this.storyData = {
            1: {
                title: "Je suis impuissante",
                text: "Elle se trouvait à terre, couvée entre les ronces d’un buisson. Sa stature ainsi que son apparence étaient malpropres, ternis d'éraflures et de boue. Son regard ne se distrayait pas de la cible abstraite devant elle, et sa bouche entrouverte paraissait en suspens. Je me suis trouvée stupéfaite qu’elle n’entreprit pas de faire l’effort de se dignifier, surtout lorsqu’elle fut sujet à ma présence. Elle m’a tant accoutumée à ne pas négliger mes étiquettes que d’être témoin de son laxisme était presque ironique. Cela ne m’a pas convenu.\n" +
                    "J'approchai de nouveau et pris sa main, terriblement froide. Son battement cardiaque était quasiment indiscernable, comme sa respiration. C’est à ce moment que j’ai remarqué l’expression lourde, faible, fatiguée de son visage. Elle ne semblait pas vouloir persister à vivre. Sans mon accord. J’ai refusé. Je l’ai prise par le bras pour la relever qu’elle tomba sur ses genoux. Avait-elle oublié la promesse qu’elle m'avait faite, de ne pas se considérer soumise ?\n" +
                    "Je me suis ajustée à sa hauteur pour l’entendre murmurer la tête baissée. Ses paroles s'adressaient à moi. Des paroles si sottes. Si futiles. Je l’ai enlacée dans mes bras, et entrepris de lui partager mon █████. Elle se mit à luire. Rapidement, son visage ainsi que les extrémités de ses doigts se mirent à saigner, son corps n'était pas suffisamment puissant pour être compatible. J’ai arrêté immédiatement le processus. Elle succomba à la gravité et tomba sur le côté.\n" +
                    "Elle ne m'a pas répondu lorsque je l’ai appelée. Elle ne m’a pas obéi lorsque je lui ai ordonné d’ouvrir les yeux. Elle n'a pas réagi lorsque je l’ai secouée. Elle n’a pas bronché lorsque je l’ai frappée au visage. Elle n'a même pas pris la peine d’essuyer les larmes qui tombaient sur ses joues.\n" +
                    "Je suis impuissante face à la mortalité.\n",
                image: "assets/img/Tristesse.jpg"
            },
            2: {
                title: "Les Cristaux Chantants",
                text: "De nouveau seule, j’entendis les pas de l’organisatrice s’éloigner, progressivement noyés dans les rires et conversations enjouées du couloir. Mon attention se redirigea vers toutes les fleurs que mes convives m’avaient apportées aujourd’hui. Ils m’en avaient tellement offert ! Pourquoi ne pas me les donner tout au long de l’année, que je puisse profiter de chaque plante individuellement plutôt que de me les donner toutes au même moment ? Deux enfants rentrèrent alors dans la pièce, perdus, et prirent immédiatement conscience de leur faux-pas. À peine eurent-ils le temps de s’excuser que les pas de l’organisatrice, lourds cette fois-ci, se rapprochèrent dangereusement. Paniqué, le garçon décida de se cacher derrière moi, faute de meilleur refuge. La fille, hésitante, resta figée sur place en me regardant l’air inquiet. Le garçon prit sa main et l’emmena vers sa cachette lorsque l’organisatrice rentra poliment dans la pièce.\n" +
                    "Elle scruta la pièce d’un coup d'œil expert, puis s’excusa de son intrusion soudaine et partit. L’ampleur de ma robe n’eut aucun mal à dissimuler les deux fugitifs. Une fois partie pour de bon, les enfants et moi-même nous mîmes à rigoler. Je leur ai alors expliqué qu’ils n’avaient pas la permission de rester ici, mais dans un élan de nourrir l’esprit de complicité je pris une fleur de mon bouquet et la leur offris. La Lépida avait une forme ressemblant à un papillon, et symbolisait le bonheur que l’on trouve dans les instants éphémères. La jeune fille prit la fleur de mes mains et m'offrit en retour un grand sourire. Légère, elle se tourna vers le garçon et lui tendit mon cadeau, sans doute pour récompenser son héroïsme. Son visage vira au rouge, puis il prit la tige de la fleur avec timidité. Il baissa la tête et, non pas sans un regard lancé à la fille, il nous tourna le dos pour examiner la plante. \n" +
                    "Elle prit alors sa main et se dirigea vers la porte. Elle me fit un grand geste de son bras et sortit de la pièce. Quant au garçon qu’elle emmenait avec elle, il était trop préoccupé par ce qu’il tenait pour me saluer. La porte se referma et le calme reprit sa place pendant quelques minutes, avant que l’on ne toque à la porte. Je pris mon bouquet et sortis de la pièce.\n",
                image: "assets/img/Mariage.jpg"
            },
            3: {
                title: "Pour mon enfant",
                text: "Les bruits de pas sur la pierre rythmaient mon ascension de l’escalier tourbillonnant. Crescendo, le crépitement de la cheminée me parvenait lorsque la porte s’ouvrit en tonnerre. Un cri s’échappa de mon épouse avant qu’elle ne soit étouffée par la stupeur. Sugistain essaya de faire usage de ma puissance, mais je refusai. Agacé, il prit une bouteille du comptoir et la brisa sur le coin du meuble. Le murmure du brasier de nouveau interrompu, ma femme me lança un dernier regard avant de s’éclipser de la pièce. Ses yeux m’ont parlé de ses craintes, peurs et appréhensions. Son désespoir m’implora d’intervenir. J’ordonnai à Sugistain de freiner sa frénésie, mais il ne m’écouta pas.\n" +
                    "Il abandonna la mélodie du feu pour chasser Uthopa dans le foyer. Il l’attrapa par le cou et logea son arme dans son ventre. J’ai juré, j’ai crié, mais il n'a pas lâché prise. Après une longue pause, elle s’effondra sur le sol, muette. Je n’ai pu qu’assister à la scène, et sans prendre le temps de comprendre son silence, je repartis dans le salon. Je n’entendais ni le bruit de ses pas ni le chant des flammes, mais que le vacarme sanguin de son rythme cardiaque assourdissant. Au moment où Sugistain se dirigea vers l’étage supérieur, je compris ses intentions les plus sinistres. Il allait s’en prendre à ma fille.\n" +
                    "J’ai utilisé mon █████ pour tenter de l’arrêter. J’ai aussi sous-estimé le contrôle qu’il pouvait exercer sur moi et mes capacités. Utilisant ma force, il prit de la vitesse et enfonça la porte verrouillée de la chambre de mon enfant. Je me mis à me saigner de son corps, affrontant son contrôle par ma volonté. Ma détermination fit flancher son pouvoir, il lâcha prise, et je parvins à m’extirper de lui. Maintenant mes mains autour de son cou, je sentis son pouls traître pulser sous mes doigts. Il battit fort, voulant lui aussi se libérer de cette emprise. Je ne faiblis pas, et lentement, il se calma, avant de sombrer dans un sommeil éternel.\n" +
                    "Je pris connaissance de mes alentours pour découvrir la fenêtre, béante, donnant sur la plus belle vue de Solstice que la vie peut s’offrir. Orpheline, le sang de Sugistain semblait encore me traverser.\n",
                image: "assets/img/Colere.jpg"
            },
            4: {
                title: "Célesticide",
                text:
                    "\n" +
                    "Ses jambes la lâchèrent, et la créature percuta le sol. Meurtrie et sans doute épuisée, son état ne semblait pas la préoccuper dans sa course. Elle rampa lentement vers sa mort, animée uniquement par son désir de destruction. Je finis par l’achever et poursuivis l’exploration de leur antre. Les cristaux d’█████ permettaient de se frayer un chemin aisément parmi les roches et autres obstacles qui seraient tombés du plafond de la grotte. Au fur et à mesure de mon avancée, les prismes de lumière devenaient de plus en plus fréquents. Je découvris éventuellement un immense lac souterrain. L’eau était bleue phosphorescente, et de petits morceaux de cristaux flottaient en surface. Elle restait cependant translucide, et je pouvais distinguer des gisements de cristaux au fond du bassin. La plupart semblaient… brisés.\n" +
                    "Soudain, la cave se mit à vibrer violemment. Le plafond se fissura au-dessus de ma tête. Je tournai rapidement mes talons et entamai mon ascension vers la surface. Je me frayai un chemin parmi les créatures de boue et de prismes que j’ai abattues lors de ma descente pour me retrouver en quelques minutes à l’entrée de la grotte. À mon arrivée, Ajiia me sauta dans les bras. Son visage était gonflé par ses pleurs, mais je m’efforçai de me focaliser sur la situation. Je levai la tête. Les nuages appartenant avant aux cieux ont été perforés par mes semblables. Le Célesticide avait déjà commencé.\n" +
                    "J'ai pris Ajiia dans mes bras et courus vers Beledaze. Le ciel avait viré au bleu lumineux, et l’air était devenu condensé. Elle se mit à tousser violemment, et je sus que je ne pouvais pas lui venir en aide. Je découvris alors l’état de la capitale après avoir passé la colline de Rochefaç. Je ne pouvais qu’en voir les contours, la ville était submergée par la lumière obnubilante des atherarchs. Un frisson, puis un froid paralysant me parcourut le corps. Je n’étais plus l’un des leurs, car je ne pouvais pas les comprendre. Cela signifiait également que j’étais leur ennemi… leur cible. Je suis resté encore un moment à regarder le spectacle sinistre se déroulant devant mes yeux, incapable de me projeter dans mon destin. Je repris Ajiia dans mes bras et pris la fuite, loin du conflit.\n" +
                    "\n",
                image: "assets/img/Peur.jpg"
            },
            5: {
                title: "Mon █████",
                text:
                    "Par endroits, sa peau était couverte d’écailles. Elle avait les traits jeunes d’un enfant, et était constituée approximativement comme un humain. Des petites cornes décoraient ses longs cheveux nacrés, avec des oreilles tirées vers le haut de part et d’autre de sa tête. Sans oublier, dans son dos, une petite paire d’ailes venues de très loin. Quant à ses yeux, je ne l’ai pas su. Ils étaient fermés. \n" +
                    "Je repensai à mes années vécues parmi les vivants. Des images, lieux, mémoires et sensations peignaient mon esprit. Un tableau apparut alors, colorié par les mille pinceaux que j’ai eu le privilège de manier au cours de mon temps parmi eux. Rouge sang, jaune tournesol, vert taupe, rose ruban, bleu océan, blanc sourire. Chaque mémoire imbibée de la sagesse des mortels venait participer à la création de cette toile. Chaque nuance avait un sens irréfutable, mais aucun n’était explicable. Cette œuvre, compilation de milliers d’années de vécues, peuples et races confondus, je lui en ai fait don. Je lui ai offert sa mortalité.\n" +
                    "Doux comme une caresse, puis voyageur, puis tourbillonnant, mon █████ la porta au centre de la pièce. Peu à peu, il s’appropria l’espace et se concrétisa dans la matière. Elle, sage, se laissa porter par les courants célestes. Tel une chrysalide, ce cocon se forma lentement autour d’elle avec la plus grande délicatesse pour son hôte. Des instants passèrent, et un cristal bleu luminescent finit par la recouvrir. Les préparatifs pour le processus d’incubation achevés, et son essence protégée par ma puissance, une seule pensée m’occupait alors l'esprit : l’espoir, la certitude de la voir à nouveau, de plonger mon regard dans le sien et d’y voir sa mortalité. Seulement à ce moment-là, nous pourrons créer un avenir nouveau.\n" +
                    "\n",
                image: "assets/img/Espoir.jpg"
            },
            athulan: {
                title: "█████",
                text: "̺̾W̴̤̋ȟ̴̫á̸̺t̷̖̿ ̴̘͆î̸̦s̷̩̀ ̴̪͑█̴͔̍█̸̞͒█̸̙͌█̵̘̈́█̷̗̌ ̵̰͝?̸̱͌",
                image: "assets/img/athulan.jpg"
            }
        };

        this.currentOverlay = null;
        this.currentZoneNumber = null;
        this.isMobile = false;
        this.zoneManager = null; // Sera défini plus tard
        this.setupStyles();
    }

    setZoneManager(zoneManager) {
        this.zoneManager = zoneManager;
    }

    setupStyles() {
        if (!document.querySelector('#typewriter-styles')) {
            const style = document.createElement('style');
            style.id = 'typewriter-styles';
            style.textContent = `
                @keyframes fadeInChar {
                    0% { opacity: 0; transform: translateY(10px); }
                    100% { opacity: 1; transform: translateY(0); }
                }
                @keyframes fadeOut {
                    0% { opacity: 1; }
                    100% { opacity: 0; }
                }
                
                /* Cursed text effect for Athulan */
                .story-text.cursed-text {
                    font-family: 'Caveat', 'Kalam', cursive;
                    text-shadow: 
                        0 0 3px rgba(138, 43, 226, 0.5),
                        0 0 6px rgba(138, 43, 226, 0.3),
                        2px 2px 4px rgba(0, 0, 0, 0.8);
                    letter-spacing: 1px;
                }
                
                .story-text.cursed-text span {
                    display: inline-block;
                    animation: cursedGlitch 0.5s ease-in-out infinite;
                    animation-delay: calc(var(--char-index) * 0.05s);
                }
                
                @keyframes cursedGlitch {
                    0%, 90%, 100% {
                        transform: translateX(0) translateY(0) rotate(0deg);
                        opacity: 1;
                    }
                    92% {
                        transform: translateX(-2px) translateY(1px) rotate(-1deg);
                        opacity: 0.8;
                    }
                    94% {
                        transform: translateX(2px) translateY(-1px) rotate(1deg);
                        opacity: 0.9;
                    }
                    96% {
                        transform: translateX(-1px) translateY(0) rotate(0deg);
                        opacity: 0.7;
                    }
                }
                
                .story-title.cursed-title {
                    animation: titleCorruption 4s ease-in-out infinite;
                    text-shadow:
                        0 0 10px rgba(138, 43, 226, 0.8),
                        0 0 20px rgba(138, 43, 226, 0.6),
                        0 0 30px rgba(138, 43, 226, 0.4),
                        2px 2px 4px rgba(0, 0, 0, 1);
                }
                
                @keyframes titleCorruption {
                    0%, 100% {
                        transform: rotate(-1deg) skewX(-2deg) translateX(0px);
                        filter: blur(0px);
                    }
                    25% {
                        transform: rotate(-0.5deg) skewX(-3deg) translateX(2px);
                        filter: blur(0.5px);
                    }
                    50% {
                        transform: rotate(-1.5deg) skewX(-1deg) translateX(-1px);
                        filter: blur(0.2px);
                    }
                    75% {
                        transform: rotate(-0.8deg) skewX(-2.5deg) translateX(1px);
                        filter: blur(0.3px);
                    }
                }
            `;
            document.head.appendChild(style);
        }
    }

    openStory(zoneNumber, isMobile = false) {
        const existingOverlay = document.querySelector('.story-overlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }

        const story = this.storyData[zoneNumber];
        if (!story) return;

        this.currentZoneNumber = zoneNumber;
        this.isMobile = isMobile;
        this.createStoryOverlay(story, zoneNumber);
    }

    createStoryOverlay(story, zoneNumber) {
        // Create main overlay
        const overlay = document.createElement('div');
        overlay.className = 'story-overlay';

        // Add special class for Athulan story
        if (zoneNumber === 'athulan') {
            overlay.classList.add('athulan-story');
        }

        // Create background image
        const background = document.createElement('div');
        background.className = 'story-background distortion-active';
        background.style.backgroundImage = `url('${story.image}')`;

        // Create particles
        const particles = document.createElement('div');
        particles.className = 'story-particles';

        // Generate particles
        for (let i = 0; i < 40; i++) {
            const particle = document.createElement('div');
            particle.className = 'story-particle';
            if (i % 3 === 0) {
                particle.classList.add('distortion-active');
            }
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (18 + Math.random() * 7) + 's';
            particles.appendChild(particle);
        }

        // Create content container
        const content = document.createElement('div');
        content.className = 'story-content';

        // Create text container
        const textContainer = document.createElement('div');
        textContainer.className = 'story-text-container distortion-active';

        // Add image mask
        const imageMask = document.createElement('div');
        imageMask.className = 'story-image-mask';
        imageMask.style.backgroundImage = `url('${story.image}')`;
        textContainer.appendChild(imageMask);

        // Create title
        const title = document.createElement('h1');
        title.className = 'story-title distortion-active';
        if (zoneNumber === 'athulan') {
            title.classList.add('cursed-title');
        }
        title.textContent = story.title;

        // Create text area
        const storyText = document.createElement('div');
        storyText.className = 'story-text';
        if (zoneNumber === 'athulan') {
            storyText.classList.add('cursed-text');
        }

        // Create cursor
        const cursor = document.createElement('span');
        cursor.className = 'typewriter-cursor';

        // Create decorative elements
        const decorLeft = document.createElement('div');
        decorLeft.className = 'story-decor-left';
        const decorRight = document.createElement('div');
        decorRight.className = 'story-decor-right';

        // Create close button
        const closeButton = document.createElement('div');
        closeButton.className = 'story-close-button';

        // Assemble elements
        textContainer.appendChild(decorLeft);
        textContainer.appendChild(title);
        textContainer.appendChild(storyText);
        textContainer.appendChild(decorRight);

        content.appendChild(textContainer);

        overlay.appendChild(background);
        overlay.appendChild(particles);
        overlay.appendChild(content);
        overlay.appendChild(closeButton);

        document.body.appendChild(overlay);

        // Animate appearance
        setTimeout(() => {
            overlay.classList.add('active');
        }, 100);

        // Start typewriter effect
        setTimeout(() => {
            this.typeWriterEffect(storyText, story.text, cursor, zoneNumber === 'athulan');
        }, 1500);

        // Event handlers
        closeButton.addEventListener('click', () => {
            this.closeStoryOverlay(overlay);
        });

        // Escape key handler
        const escapeHandler = (e) => {
            if (e.key === 'Escape') {
                this.closeStoryOverlay(overlay);
                document.removeEventListener('keydown', escapeHandler);
            }
        };
        document.addEventListener('keydown', escapeHandler);

        this.currentOverlay = overlay;
    }

    closeStoryOverlay(overlay) {
        overlay.classList.remove('active');

        // Informer le ZoneManager si on est sur mobile
        if (this.isMobile && this.zoneManager && this.currentZoneNumber) {
            setTimeout(() => {
                this.zoneManager.onMobileStoryClosed(this.currentZoneNumber);
            }, 300);
        }

        // Nettoyer les animations
        const animatedElements = overlay.querySelectorAll('[style*="animation"]');
        animatedElements.forEach(el => {
            el.style.animation = 'none';
        });

        // Nettoyer les particules
        const particles = overlay.querySelector('.story-particles');
        if (particles) {
            particles.innerHTML = '';
        }

        setTimeout(() => {
            overlay.remove();
        }, 800);
    }

    typeWriterEffect(element, text, cursor = null, isCursed = false) {
        element.textContent = '';

        // Option 1 : Affichage par paragraphes (BEAUCOUP plus performant)
        const paragraphs = text.split('\n').filter(p => p.trim());
        let paragraphIndex = 0;

        const showParagraph = () => {
            if (paragraphIndex < paragraphs.length) {
                const p = document.createElement('p');
                p.textContent = paragraphs[paragraphIndex];
                p.style.opacity = '0';
                p.style.animation = 'fadeInParagraph 0.8s ease forwards';

                if (isCursed) {
                    p.classList.add('cursed-paragraph');
                }

                element.appendChild(p);
                paragraphIndex++;

                // Délai réduit entre paragraphes
                setTimeout(showParagraph, 600);
            }
        };

        setTimeout(showParagraph, 500);
    }
}